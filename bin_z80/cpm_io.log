0000:           ;zasm -v2 -i cpm_io.asm -o cpm_io.rom
0000:           ;#target bin
0000:           ; SYMBOLIC DEFINES
0000:           ; $8x selects the UART addressing lines
0000:           UART_PORT	equ 80h	; The UART's data buffer for in/out
0000:           UART_DLL	equ	80h	; LSB of divisor latch
0000:           UART_DLM	equ 81h	; MSB of divisor latch (DLAB=1)
0000:           UART_FCR	equ	82h	; FIFO control register
0000:           UART_IER	equ	81h	; Interrupt Enable register (DLAB=0)
0000:           UART_LCR	equ	83h	; Line Control Register
0000:           UART_MCR	equ 84h	; Modem Control Register (for OUT1/OUT2)
0000:           UART_LSR	equ	85h	; Line Status Register (used for transmitter empty bit)
0000:           
0000:           #target	rom		; ((inserted by zasm))
0000:           #code	0,$10000	; ((inserted by zasm))
0000:               org 0
0000: D300          out (0), A
0002:               ;Ensure is at memory address 5, for CP/M BDOS
0002: 000000        defs 5-$, 0
0005: F5            PUSH AF
0006: D5            push de
0007: 79            ld a, c
0008: FE02          cp 2
000A: CC1500        call z, preoutchar
000D: FE09          cp 9
000F: CC2200        call z, outmulti
0012: D1            pop de
0013: F1            POP AF
0014: C9            ret
0015:           ;----------------------------------------------------
0015:           preoutchar:
0015: 7B            ld a, e
0016:           outchar:
0016: F5            PUSH AF
0017: D380          OUT (UART_PORT), A
0019:           ; wait until transmitted
0019:           oloop:
0019: DB85          IN A, (UART_LSR)	; read LSR
001B: CB77          BIT 6, A	; bit 6 is transmitter empty
001D: CA1900        JP Z, oloop
0020: F1            POP AF
0021: C9            RET
0022:           ;----------------------------------------------------
0022:           outmulti:
0022: 1A            ld a, (de)
0023: FE24          cp a, '$'
0025: CA2F00        jp z, outend
0028: CD1600        call outchar
002B: 13            inc de
002C: C32200        jp outmulti
002F:           outend:
002F: C9            ret
0030:           #end			; ((inserted by zasm))
